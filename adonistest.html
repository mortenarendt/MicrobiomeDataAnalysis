<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>ANOVA on Beta Diversity</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<div class="container-fluid main-container">

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->





<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Microbiome Data Analysis</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="about.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Descriptives
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="pkgs.html">Packages</a>
    </li>
    <li>
      <a href="prepro.html">Preprocessing</a>
    </li>
    <li>
      <a href="alphadiv.html">alpha diversity</a>
    </li>
    <li>
      <a href="betadiv.html">beta diversity</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Statistical inference
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="DA.html">Differential Abundance</a>
    </li>
    <li>
      <a href="adonistest.html">ANOVA on beta diversity</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Supervised Multivariate models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="hm.html">Heatmaps</a>
    </li>
    <li>
      <a href="cca.html">Canonical Correlation Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="https://github.com/mortenarendt/MicrobiomeDataAnalysis/tree/master/data">Data</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">ANOVA on Beta Diversity</h1>

</div>


<p>Statistical inference, is the term used for veryfying how likely the <em>observed</em> difference is due to chance (the null hypothesis). The t-test is one of the most used methods for this purpose, and having univariate response variables makes statistical inference straight-forward.</p>
<p>For multivariate data things become slightly more complicated. However, when dealing with beta-diversity type of data, there is a nice one-2-one relationship with ANOVA for univariate data.</p>
<p>The general model a single response <span class="math inline">\(y\)</span> from a design <span class="math inline">\(D\)</span> for ANVOA is</p>
<p><span class="math display">\[\mathbf{y} = \mathbf{D}\mathbf{\beta} + \mathbf{e}\]</span> where <span class="math inline">\(\mathbf{\beta}\)</span> is the model parameters and <span class="math inline">\(\mathbf{e}\)</span> the residuals.</p>
<p>In ANOVA the basic principal is to compare the <em>size</em> of the residuals with the size of the modelled part <span class="math inline">\(\mathbf{\hat{y}} = \mathbf{D}\mathbf{\beta}\)</span>. Where size is a summed of squares thing: <span class="math inline">\(SS_{resid} = \sum(e^2) = \mathbf{e}^T\mathbf{e}\)</span> and <span class="math inline">\(SS_{model} = \sum(\hat{y}^2) = \mathbf{y}^T\mathbf{y} - \mathbf{e}^T\mathbf{e}\)</span></p>
<p>For multivariate matrices as response variables this formula extends to:</p>
<p><span class="math display">\[\mathbf{Y} = D \mathbf{\beta} + \mathbf{E} = \hat{\mathbf{Y}} + \mathbf{E}\]</span></p>
<p>with Sums of Squares being:</p>
<p><span class="math display">\[SS_{total} = SS_{model} + SS_{resid}\]</span></p>
<p><span class="math display">\[tr(\mathbf{Y}&#39;\mathbf{Y}) = tr(\mathbf{\hat{Y}&#39;}\mathbf{\hat{Y}}) + tr(\mathbf{E}&#39;\mathbf{E})\]</span> Due to trace invariance this is the same as:</p>
<p><span class="math display">\[tr(\mathbf{Y}\mathbf{Y}&#39;) = tr(\mathbf{\hat{Y}}\mathbf{\hat{Y}}&#39;) + tr(\mathbf{E}\mathbf{E}&#39;)\]</span> What we see here is that the data representation <span class="math inline">\(\mathbf{Y}\mathbf{Y}&#39;\)</span> is exactly a similar representation as the <span class="math inline">\(\beta\)</span> diversity. Namely, a symmetric sample by sample matrix. Furhter utilizing the definition of the so-called hat matrix:</p>
<p><span class="math display">\[ \mathbf{H} = \mathbf{D}(\mathbf{D}&#39;\mathbf{D})^{-1}\mathbf{D}\]</span> which puts a hat on <span class="math inline">\(\mathbf{Y}\)</span>: <span class="math inline">\(\mathbf{\hat{Y}} = \mathbf{H}\mathbf{Y}\)</span>.</p>
<p>This, combined with <strong>Pytagoras</strong>, orthogonality between the model and the residuals, shows that the only thing needed to be able to do multivariate anova is the sample by sample matrix.</p>
<p>the vegan library with the function adonis() utilizes this to make linear models on <span class="math inline">\(\beta\)</span> diversity. However, there are no analytical <em>null</em> distribution for testing, why this is constructed by random permutation.</p>
<div id="compute-sample-by-sample-distance-matrix" class="section level1 unnumbered">
<h1>Compute sample by sample distance matrix</h1>
<p>Here the pairwise sample distance is calculated, and printed for the first three samples.</p>
<pre class="r"><code>library(vegan)
library(phyloseq)
load(&#39;./data/Rats_inulin.RData&#39;)
D_BC &lt;- phyloseq::distance(phyX, &quot;bray&quot;)
as.matrix(D_BC)[1:3,1:3]</code></pre>
<pre><code>##                    NXT005.REB.002.S92 NXT005.REB.003.S93
## NXT005.REB.002.S92          0.0000000          0.3826576
## NXT005.REB.003.S93          0.3826576          0.0000000
## NXT005.REB.004.S94          0.4892783          0.3484405
##                    NXT005.REB.004.S94
## NXT005.REB.002.S92          0.4892783
## NXT005.REB.003.S93          0.3484405
## NXT005.REB.004.S94          0.0000000</code></pre>
<p>The diagonal is zeros. Although the formulations above works on <em>similarity matrices</em> the adonis() function takes <em>dissimilarities</em> as input.</p>
<p>Here is a linear model depending on the factor time:</p>
<pre class="r"><code>adonis(D_BC ~ time, data = data.frame(sample_data(phyX)))</code></pre>
<pre><code>## 
## Call:
## adonis(formula = D_BC ~ time, data = data.frame(sample_data(phyX))) 
## 
## Permutation: free
## Number of permutations: 999
## 
## Terms added sequentially (first to last)
## 
##           Df SumsOfSqs MeanSqs F.Model      R2 Pr(&gt;F)    
## time       1    3.2052  3.2052  18.834 0.24835  0.001 ***
## Residuals 57    9.7007  0.1702         0.75165           
## Total     58   12.9060                 1.00000           
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<p>However, more interestingly it is to compare the effect of diet in combination with time</p>
<pre class="r"><code>mdl&lt;- adonis(D_BC ~ time*Description, data = data.frame(sample_data(phyX)))
mdl</code></pre>
<pre><code>## 
## Call:
## adonis(formula = D_BC ~ time * Description, data = data.frame(sample_data(phyX))) 
## 
## Permutation: free
## Number of permutations: 999
## 
## Terms added sequentially (first to last)
## 
##                  Df SumsOfSqs MeanSqs F.Model      R2 Pr(&gt;F)    
## time              1    3.2052  3.2052 23.7182 0.24835  0.001 ***
## Description       2    1.1981  0.5990  4.4329 0.09283  0.001 ***
## time:Description  2    1.3403  0.6702  4.9591 0.10385  0.001 ***
## Residuals        53    7.1623  0.1351         0.55496           
## Total            58   12.9060                 1.00000           
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1</code></pre>
<pre class="r"><code>SSQ &lt;- mdl$aov.tab$SumsOfSqs
tbanova &lt;- data.frame(source = rownames(mdl$aov.tab), 
                      SSQrel = 100*SSQ/SSQ[5], 
                      pv = mdl$aov.tab$`Pr(&gt;F)`)
knitr::kable(tbanova,digits = c(0,1,5))</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">source</th>
<th align="right">SSQrel</th>
<th align="right">pv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">time</td>
<td align="right">24.8</td>
<td align="right">0.001</td>
</tr>
<tr class="even">
<td align="left">Description</td>
<td align="right">9.3</td>
<td align="right">0.001</td>
</tr>
<tr class="odd">
<td align="left">time:Description</td>
<td align="right">10.4</td>
<td align="right">0.001</td>
</tr>
<tr class="even">
<td align="left">Residuals</td>
<td align="right">55.5</td>
<td align="right"></td>
</tr>
<tr class="odd">
<td align="left">Total</td>
<td align="right">100.0</td>
<td align="right"></td>
</tr>
</tbody>
</table>
<p>Time is naturally the most influencial factor, but not supprisingly, The diet (<em>Decription</em>) contributes somewhat 10 percent of the variantion, but further strongly depends on time. Thinking about the design, this does make a lot of sense.</p>
</div>
<div id="exercises" class="section level1">
<h1><span class="header-section-number">1</span> Exercises</h1>
<div id="permanova" class="section level2">
<h2><span class="header-section-number">1.1</span> Permanova</h2>
<p>Run the permanova / adonis tests above.</p>
</div>
<div id="different-beta-div-methods" class="section level2">
<h2><span class="header-section-number">1.2</span> Different beta-div methods</h2>
<p>Try to exchange the method for <span class="math inline">\(\beta\)</span> diversity and check what happends.</p>
</div>
<div id="differences-at-baseline" class="section level2">
<h2><span class="header-section-number">1.3</span> Differences at baseline?</h2>
<p>At time <em>start</em> no dietarry intervention has been introduced, and hence, no differences between diet-groups are expected. Test if this is the case.</p>
</div>
<div id="metabolite-correlations" class="section level2">
<h2><span class="header-section-number">1.4</span> Metabolite correlations</h2>
<p>At the end of trial fecal water metabolomics is included. Investigate whether some of these can explain the beta diversity variation. Further, try to make a visualization where metabolite levels is included.</p>
</div>
<div id="microbiome---diet---metabolome-interactions" class="section level2">
<h2><span class="header-section-number">1.5</span> Microbiome - Diet - Metabolome interactions</h2>
<p>Furhter, investigate if, for some metabolites, the association between metabolites and microbiome is only introduced by the design. I.e. when accounting for the effect of the design, the metabolite-microbiome associations becomes weaker.</p>
<pre class="r"><code>phyXsel &lt;- subset_samples(phyX, time == &#39;Slut&#39;)
D_BC &lt;- phyloseq::distance(phyXsel, &quot;bray&quot;)

adonis(D_BC ~ Fructose, data = data.frame(sample_data(phyXsel)))
adonis(D_BC ~ Description + Fructose, data = data.frame(sample_data(phyXsel)))</code></pre>
</div>
<div id="wihtin-subject-memory" class="section level2">
<h2><span class="header-section-number">1.6</span> Wihtin subject memory</h2>
<p>Within each diet group, test if there is memory in microbiome over time. That is, how large degree of the variation is due to the individual mice? Is the degree of memory the same for the diffent diets?</p>
</div>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<p>McArdle, Brian H., and Marti J. Anderson. <strong>Fitting multivariate models to community data: a comment on distance‐based redundancy analysis</strong> Ecology 82, no. 1 (2001): 290-297.</p>
<p>Xia, Yinglin, Jun Sun, and Ding-Geng Chen. <strong>Statistical analysis of microbiome data with R</strong>. Springer, 2018. Chapter 6.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
